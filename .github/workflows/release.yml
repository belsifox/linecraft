name: Build & Release

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ] # e.g. v1.2.3

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: gradle

      - name: Debug Maven Central access
        run: |
          curl -I https://repo.maven.apache.org/maven2/com/google/code/gson/gson/2.10.1/gson-2.10.1.pom || true

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Build (Gradle)
        run: ./gradlew build

      - name: Collect artifacts
        run: |
          mkdir -p dist
          find build/libs -maxdepth 1 -type f -name "*.jar" -print -exec cp -v {} dist/ \;
          echo "Collected:"
          ls -lah dist

      - name: Upload workflow artifacts
        uses: actions/upload-artifact@v4
        with:
          name: jars
          path: dist/*.jar
          if-no-files-found: error

      # ---------- TAG PUSHES: create a real release ----------
      - name: Create GitHub Release (tags)
        if: startsWith(github.ref, 'refs/tags/')
        id: tag_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          prerelease: false
          generate_release_notes: true
          files: dist/*.jar

      # ---------- MAIN PUSHES: create/update a prerelease ----------
      - name: Create/Update prerelease tag "dev" (main branch)
        if: github.ref == 'refs/heads/main'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git tag -f dev "${GITHUB_SHA}"
          git push -f origin dev

      - name: Publish/Update prerelease "dev" (main branch)
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: dev
          name: "Dev (latest main)"
          prerelease: true
          generate_release_notes: true
          files: dist/*.jar

      # ---------- MODRINTH ----------
      - name: Prepare Modrinth metadata
        id: mrmeta
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            TAG="${GITHUB_REF_NAME}"
            VERSION="${TAG#v}"
            VERSION_TYPE="release"
            NAME="${TAG}"
            # Changelog: commits since previous tag (best-effort)
            PREV_TAG="$(git describe --tags --abbrev=0 "${TAG}^" 2>/dev/null || true)"
            if [[ -n "${PREV_TAG}" ]]; then
              git log --no-merges --pretty=format:"- %s (%h)" "${PREV_TAG}..${TAG}" > CHANGELOG_RELEASE.md
            else
              git log --no-merges --pretty=format:"- %s (%h)" -n 50 > CHANGELOG_RELEASE.md
            fi
          else
            SHORT_SHA="$(echo "${GITHUB_SHA}" | cut -c1-7)"
            VERSION="dev-${GITHUB_RUN_NUMBER}-${SHORT_SHA}"
            VERSION_TYPE="alpha"
            NAME="Dev build ${SHORT_SHA}"
            git log --no-merges --pretty=format:"- %s (%h)" -n 1 > CHANGELOG_RELEASE.md
          fi

          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "version_type=${VERSION_TYPE}" >> "$GITHUB_OUTPUT"
          echo "name=${NAME}" >> "$GITHUB_OUTPUT"

          echo "Changelog:"
          cat CHANGELOG_RELEASE.md

      - name: Publish to Modrinth
        # Publishes on BOTH main pushes and tag pushes (different version/version_type from mrmeta)
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          modrinth-id: linecraft-mod
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}
          modrinth-featured: true

          # What to upload
          files: |
            dist/linecraft-*[!s].jar

          # Versioning + changelog
          name: ${{ steps.mrmeta.outputs.name }}
          version: ${{ steps.mrmeta.outputs.version }}
          version-type: ${{ steps.mrmeta.outputs.version_type }}
